# EDS定时任务服务（cron.rpc）

## 🔖简介

> EDS部分功能依赖于外部机构定期/不定期发布的数据，人为录入存在时效性、准确性和重复性困难，开发定时任务服务(cron.rpc)解决此类问题。

任务类型：

|类型标识|名称|数据源|
|-|-|-|
|dlgd|代理购电|[国家电网](https://95598.cn/osgweb/index)、[南方电网](https://95598.csg.cn/)|
|holiday|节假日|[各国假期日历](https://holidays-calendar.net/)|
|weather|天气预报|[中央气象台](http://www.nmc.cn/)|
|carbon|碳排因子|[国家碳排因子库](https://data.ncsc.org.cn/factoryes/index)|
|re-dlgd|复核代理购电[^1] |系统数据库|

[^1]: 系统中只允许存在1个

## 🐼前提条件

政府类网站具有较强的反爬虫机制，用[chromedp](https://github.com/chromedp/chromedp)模拟人为操作，通过点击、跳转和选择等动作提取网页关键元素。

**运行依赖**：

- 本地需安装 Chrome/Chromium 或兼容浏览器（如 Edge）
- 构建docker镜像时需安装chromedp所需的依赖（Chromium + 必要库）

## 🎸接口列表

### GetEnergyOptions：基于地址获取能源可选项

```json
// 请求参数
{
    "address": "福建省厦门市集美区孙坂南路92号"
}

// 返回响应
// success
{
    "categories": [
        "福建>工商业,两部制>1-10（20）千伏",
        "福建>工商业,两部制>110千伏",
        "福建>工商业,两部制>220千伏及以上",
        "福建>工商业,两部制>35千伏",
        "福建>工商业,单一制>1-10（20）千伏",
        "福建>工商业,单一制>110千伏",
        "福建>工商业,单一制>220千伏及以上",
        "福建>工商业,单一制>35千伏",
        "福建>工商业,单一制>不满1千伏"
    ],
    "powerFactors": [
        0.8,
        0.85,
        0.9
    ]
}

// error
{
    "message":"所在区域用电类别为空，请联系系统管理员。Address: 福建省厦门市集美区孙坂南路92号"
}

```

### GetCarbon: 获取碳排因子

```json
// 请求参数, year缺省时返回最新值
{
    "address": "福建省厦门市集美区孙坂南路92号",
    "year": 2025
}

// 返回响应
// 优先返回用户地址所在省级数据，不存在时返回全国数据
{
    "value": 0.4092
}
```

### AddCarbon: 新增碳排因子

```json
// 请求参数
// 大陆常访问不了台湾官方网站，可能需要手动添加
{
    "area":"台湾",
    "year":2025,
    "value":0.5
}
```

### AddCron: 新增定时任务
  
```json
// 请求参数，以代理购电为例
{
    // 任务类型，可选：dlgd, holiday, weather, carbon, re-dlgd
    "category": "dlgd", 
    // 时间参数，[task]中含[time]的均为时间参数，在执行任务时用目标时间替换，如[2025年10月]
    "time": "2006年1月",
    // 任务详情，json格式
    "task": {
        // 用chromedp采集数据
        "dp": { 
            // 跳转页面[url]及点击页面元素[clicks]，用chromedp.BySearch选择器
            // 说明：
            // 1.[2006年1月]为时间参数，详见[time]
            // 2.本例最后一步[click:2006年1月]后在浏览器新建标签页直接获取pdf的url
            "urls": [ 
                // 示例1：福建
                {
                    "url": "https://95598.cn/osgweb/index",
                    "clicks": ["city_select", "福建"]
                },
                {
                    "url": "https://95598.cn/osgweb/ipElectrovalenceStandard",
                    "clicks": ["厦门市", "同安区", "代理购电", "2006年1月"]
                }

                // 示例2：上海
                // clicks[*确认]：打开页面随机出现确认弹出框时，按[确认]按钮在进行操作
                {
                    "url": "https://95598.cn/osgweb/index",
                    "clicks": ["city_select", "上海"]
                },
                {
                    "url": "https://95598.cn/osgweb/ipElectrovalenceStandard",
                    "clicks": ["*确认", "市辖区", "宝山区", "代理购电", "2006年1月"]
                }
            ]

        },
        // 数据入库[dlgd]需[area]标签，如福建、深圳、广州/珠海/佛山/中山/东莞等
        "area": "福建",
        // pdf：页码（常用），长图：子图矩形范围比例
        "crops": ["1"],
        // 数据入库[dlgd]需[start_time]标签，亦为时间参数
        "month": "2006年1月",
        // 闽发改规〔2023〕8号文规定的峰谷时段划分
        "priceHours": [
            // 示例1：福建
            // 7,8,9三月存在尖峰电价，时段：11时-12时，17时-18时
            {
                // 0800-1000: 含8时、不含10时
                "flat": "0800-1000,1200-1500,2000-2100,2200-0000",
                "peak": "1000-1200,1500-2000,2100-2200",
                // 此时段划分仅在以下月份有效
                "months": [1, 2, 3, 4, 5, 6, 10, 11, 12],
                "valley": "0000-0800"
            },
            {
                "flat": "0800-1000,1200-1500,2000-2100,2200-0000",
                "peak": "1000-1100,1500-1700,1800-2000,2100-2200",
                "sharp": "1100-1200,1700-1800",
                "months": [7, 8, 9],
                "valley": "0000-0800"
            }

            // 示例2：珠三角五市
            // 7~9月和其他月份广州最高气温≥35℃执行尖峰电价，时段：11时-12时、15时-17时
            {
                "flat": "0800-1000,1200-1400,1900-0000",
                "peak": "1000-1200,1400-1900",
                "months": [1, 2, 3, 4, 5, 6, 10, 11, 12],
                "valley": "0000-0800"
            },
            {
                "flat": "0800-1000,1200-1400,1900-0000",
                "peak": "1000-1100,1400-1500,1700-1900",
                "sharp": "1100-1200,1500-1700",
                "months": [7, 8, 9],
                "valley": "0000-0800"
            },
            {
                "days": ["weather:广州>=35"],
                "sharp": "1100-1200,1500-1700"
            }

            // 示例3：上海（部分略）
            // 全年法定节假日和2~6、9~10月周末执行深谷电价，时段：22时-次日6时
            {
                "days": ["holiday", "weekend:2:3:4:5:6:9:10:11"],
                "deep": "2200-0600"
            }

            // 示例4：江苏（部分略）
            // 春节、劳动节和国庆节执行深谷电价，时段：11时-15时
            {
                "days": ["holiday:春节:劳动节:国庆节"],
                "deep": "1100-1500"
            }
        ],
        // 因各省市发改委电价政策(分时)不定期变化，备注区域若无以下校验文字判定整个采集过程失效，数据不入库
        "validators": ["闽发改规〔2023〕8号"]
    }
}
```

### ⚠️其他接口（不常用）

|接口名称|描述|
|-|-|
|GetCrons|获取定时任务列表|
|UpdateCron|更新定时任务|
|DeleteCron|删除定时任务|
|TodoCron|立即执行任务|
|GetHolidays|获取假日列表|
|AddHoliday|新增假日|
|DeleteHoliday|删除假日|
|GetWeathers|获取天气预报|
